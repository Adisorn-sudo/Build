name: Build Apollon Client

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build NDK Libraries
    runs-on: ubuntu-latest
    
    steps:
    # ========================================
    # 1. à¹€à¸•à¸£à¸µà¸¢à¸¡à¸ªà¸ à¸²à¸à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡
    # ========================================
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: ğŸ”§ Setup Android SDK
      uses: android-actions/setup-android@v2
      
    # ========================================
    # 2. à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ NDK
    # ========================================
    - name: ğŸ“¦ Install Android NDK
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "  Installing Android NDK 25.2.9519653"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        sdkmanager --install "ndk;25.2.9519653"
        
        export ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/25.2.9519653
        export ANDROID_NDK=$ANDROID_SDK_ROOT/ndk/25.2.9519653
        
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
        echo "ANDROID_NDK=$ANDROID_NDK" >> $GITHUB_ENV
        
        echo "âœ… NDK installed at: $ANDROID_NDK"
        ls -la $ANDROID_NDK/
        
    # ========================================
    # 3. à¹à¸•à¸ ZIP
    # ========================================
    - name: ğŸ“‚ Unzip Apollon_Client_ImGui.zip
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "  Extracting Apollon_Client_ImGui.zip"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ ! -f "Apollon_Client_ImGui.zip" ]; then
          echo "âŒ Error: Apollon_Client_ImGui.zip not found!"
          echo "Available files:"
          ls -la
          exit 1
        fi
        
        unzip -q Apollon_Client_ImGui.zip
        
        echo "âœ… Extraction completed"
        echo ""
        echo "ğŸ“ Project Structure:"
        ls -la
        
    # ========================================
    # 4. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹„à¸Ÿà¸¥à¹Œ Build
    # ========================================
    - name: ğŸ” Check Build Configuration
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "  Checking Build Files"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ -f "Android.mk" ]; then
          echo "âœ… Android.mk found"
          echo "BUILD_METHOD=ndk-build" >> $GITHUB_ENV
        elif [ -f "CMakeLists.txt" ]; then
          echo "âœ… CMakeLists.txt found"
          echo "BUILD_METHOD=cmake" >> $GITHUB_ENV
        else
          echo "âŒ No build configuration found!"
          exit 1
        fi
        
        echo ""
        echo "ğŸ“‹ Dependencies:"
        if [ -d "libraries" ]; then
          echo "âœ… libraries/ found"
          ls -R libraries/
        else
          echo "âš ï¸  libraries/ not found"
        fi
        
    # ========================================
    # 5. Build à¸”à¹‰à¸§à¸¢ ndk-build
    # ========================================
    - name: ğŸ”¨ Build with ndk-build (arm64-v8a)
      if: env.BUILD_METHOD == 'ndk-build'
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "  Building for arm64-v8a"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        $ANDROID_NDK/ndk-build \
          NDK_PROJECT_PATH=. \
          APP_BUILD_SCRIPT=./Android.mk \
          APP_ABI=arm64-v8a \
          APP_PLATFORM=android-21 \
          -j$(nproc)
          
        echo "âœ… Build completed for arm64-v8a"
        
    - name: ğŸ”¨ Build with ndk-build (armeabi-v7a)
      if: env.BUILD_METHOD == 'ndk-build'
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "  Building for armeabi-v7a"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        $ANDROID_NDK/ndk-build \
          NDK_PROJECT_PATH=. \
          APP_BUILD_SCRIPT=./Android.mk \
          APP_ABI=armeabi-v7a \
          APP_PLATFORM=android-21 \
          -j$(nproc)
          
        echo "âœ… Build completed for armeabi-v7a"
        
    # ========================================
    # 6. Build à¸”à¹‰à¸§à¸¢ CMake
    # ========================================
    - name: ğŸ”¨ Build with CMake (arm64-v8a)
      if: env.BUILD_METHOD == 'cmake'
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "  Building with CMake for arm64-v8a"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        mkdir -p build/arm64-v8a
        cd build/arm64-v8a
        
        cmake ../.. \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-21 \
          -DCMAKE_BUILD_TYPE=Release \
          -DANDROID_STL=c++_shared
          
        cmake --build . -- -j$(nproc)
        
        echo "âœ… CMake build completed for arm64-v8a"
        
    - name: ğŸ”¨ Build with CMake (armeabi-v7a)
      if: env.BUILD_METHOD == 'cmake'
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "  Building with CMake for armeabi-v7a"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        mkdir -p build/armeabi-v7a
        cd build/armeabi-v7a
        
        cmake ../.. \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=armeabi-v7a \
          -DANDROID_PLATFORM=android-21 \
          -DCMAKE_BUILD_TYPE=Release \
          -DANDROID_STL=c++_shared
          
        cmake --build . -- -j$(nproc)
        
        echo "âœ… CMake build completed for armeabi-v7a"
        
    # ========================================
    # 7. à¸£à¸§à¸šà¸£à¸§à¸¡à¹„à¸Ÿà¸¥à¹Œ
    # ========================================
    - name: ğŸ“¦ Collect Build Outputs
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "  Collecting Build Outputs"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        mkdir -p output/libs/arm64-v8a
        mkdir -p output/libs/armeabi-v7a
        
        # à¸£à¸§à¸šà¸£à¸§à¸¡à¸ˆà¸²à¸ ndk-build
        if [ -d "libs" ]; then
          cp -r libs/* output/libs/ 2>/dev/null || true
        fi
        
        # à¸£à¸§à¸šà¸£à¸§à¸¡à¸ˆà¸²à¸ obj
        if [ -d "obj/local/arm64-v8a" ]; then
          find obj/local/arm64-v8a -name "*.so" -exec cp {} output/libs/arm64-v8a/ \;
        fi
        
        if [ -d "obj/local/armeabi-v7a" ]; then
          find obj/local/armeabi-v7a -name "*.so" -exec cp {} output/libs/armeabi-v7a/ \;
        fi
        
        # à¸£à¸§à¸šà¸£à¸§à¸¡à¸ˆà¸²à¸ CMake
        if [ -d "build" ]; then
          find build -name "*.so" -type f | while read file; do
            if [[ $file == *"arm64-v8a"* ]]; then
              cp "$file" output/libs/arm64-v8a/
            elif [[ $file == *"armeabi-v7a"* ]]; then
              cp "$file" output/libs/armeabi-v7a/
            fi
          done
        fi
        
        echo "âœ… Build outputs collected"
        echo ""
        echo "ğŸ“Š Output Summary:"
        du -sh output/libs/*
        find output -name "*.so" -exec ls -lh {} \;
        
    # ========================================
    # 8. à¸ªà¸£à¹‰à¸²à¸‡ Release Package
    # ========================================
    - name: ğŸ“š Create Release Package
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "  Creating Release Package"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        cd output
        tar -czf ../Apollon-Client-libs.tar.gz libs/
        cd ..
        
        echo "âœ… Release package created"
        ls -lh Apollon-Client-libs.tar.gz
        
    # ========================================
    # 9. Upload Artifacts
    # ========================================
    - name: â¬†ï¸ Upload arm64-v8a
      uses: actions/upload-artifact@v4
      with:
        name: libs-arm64-v8a
        path: output/libs/arm64-v8a/*.so
        retention-days: 30
        
    - name: â¬†ï¸ Upload armeabi-v7a
      uses: actions/upload-artifact@v4
      with:
        name: libs-armeabi-v7a
        path: output/libs/armeabi-v7a/*.so
        retention-days: 30
        
    - name: â¬†ï¸ Upload Complete Package
      uses: actions/upload-artifact@v4
      with:
        name: Apollon-Client-Complete
        path: Apollon-Client-libs.tar.gz
        retention-days: 90
        
    # ========================================
    # 10. à¸ªà¸£à¸¸à¸›à¸œà¸¥
    # ========================================
    - name: ğŸ“ Build Summary
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘              Build Completed! âœ…                 â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“¦ Built Libraries:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        find output -name "*.so" -exec sh -c '
          file={}
          size=$(du -h "$file" | cut -f1)
          name=$(basename "$file")
          abi=$(echo "$file" | grep -oP "(arm64-v8a|armeabi-v7a)")
          printf "  %-30s [%-12s] %s\n" "$name" "$abi" "$size"
        ' \;
        
        echo ""
        echo "ğŸ‰ Artifacts uploaded to GitHub Actions!"
        echo ""
